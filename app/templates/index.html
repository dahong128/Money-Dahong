{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="space-y-8">
    <!-- Header Section -->
    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
        <div>
            <h1 class="text-3xl font-bold tracking-tight text-white" v-text="t('dashboard.title')"></h1>
            <p class="text-gray-400 mt-1" v-text="t('dashboard.subtitle')"></p>
        </div>
        <div class="flex items-center gap-3 bg-panel border border-border rounded-lg p-1.5 self-start">
            <span class="px-3 py-1.5 text-xs font-medium text-gray-400 uppercase tracking-wider" v-text="t('dashboard.updateRate')"></span>
            <span class="px-2 py-1 bg-surface rounded text-xs text-accent font-mono border border-border">2000ms</span>
        </div>
    </div>

    <section class="grid gap-6 md:grid-cols-12">
        <!-- Price Card -->
        <div class="md:col-span-8 rounded-2xl border border-border bg-panel/50 backdrop-blur-sm p-8 relative overflow-hidden group">
            <div class="absolute top-0 right-0 p-32 bg-accent/5 rounded-full blur-3xl -mr-16 -mt-16 pointer-events-none group-hover:bg-accent/10 transition-colors duration-500"></div>
            
            <div class="relative z-10 flex flex-col h-full justify-between">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-400 uppercase tracking-widest" v-text="t('dashboard.selectedAsset')"></p>
                        <h2 class="text-2xl font-bold text-white mt-1 flex items-center gap-2">
                            <span v-text="symbol"></span>
                            <span class="px-2 py-0.5 rounded text-xs bg-gray-800 text-gray-400 border border-gray-700 font-normal" v-text="t('common.spot')"></span>
                        </h2>
                    </div>
                    <div class="text-right">
                        <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-green-500/10 text-green-400 border border-green-500/20 text-xs font-medium">
                            <span class="w-1.5 h-1.5 rounded-full bg-green-400 animate-pulse"></span>
                            <span v-text="t('dashboard.liveFeed')"></span>
                        </div>
                    </div>
                </div>

                <div class="mt-8">
                    <div class="flex items-baseline gap-2">
                        <span class="text-6xl md:text-7xl font-bold tracking-tighter text-white font-mono transition-all duration-300" :class="{'text-accent': last_price_up, 'text-danger': !last_price_up}" v-text="priceDisplay"></span>
                        <span class="text-xl text-gray-500 font-medium" v-text="t('common.usdt')"></span>
                    </div>
                    <p class="mt-2 text-sm text-gray-500 font-mono">
                        <span v-text="t('dashboard.lastUpdated')"></span>
                        <span v-text="lastUpdatedDisplay"></span>
                    </p>
                </div>
            </div>
        </div>

        <!-- Control Card -->
        <div class="md:col-span-4 rounded-2xl border border-border bg-panel/50 backdrop-blur-sm p-8 flex flex-col justify-between relative overflow-hidden">
            <div>
                <h3 class="text-lg font-semibold text-white" v-text="t('dashboard.botStatus')"></h3>
                <p class="text-sm text-gray-400 mt-1" v-text="t('dashboard.botControlHint')"></p>
            </div>

            <div class="flex-1 flex flex-col justify-center items-center py-8">
                <div class="relative">
                    <div class="absolute inset-0 rounded-full blur-xl opacity-20 transition-colors duration-500" :class="status === 'Active' ? 'bg-accent' : 'bg-danger'"></div>
                    <button
                        @click="toggleBot"
                        :disabled="loading"
                        class="relative w-24 h-24 rounded-full flex items-center justify-center border-4 transition-all duration-300 transform active:scale-95 shadow-xl"
                        :class="[
                            status === 'Active' 
                                ? 'border-accent bg-accent/10 text-accent hover:bg-accent/20 hover:shadow-accent/30' 
                                : 'border-danger bg-danger/10 text-danger hover:bg-danger/20 hover:shadow-danger/30',
                            loading ? 'opacity-50 cursor-not-allowed' : ''
                        ]"
                    >
                        <svg v-if="status === 'Active'" xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <svg v-else xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 pl-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </button>
                </div>
                <p class="mt-6 font-medium text-lg" :class="status === 'Active' ? 'text-accent' : 'text-danger'" v-text="status === 'Active' ? t('status.running') : t('status.stopped')"></p>
            </div>
        </div>
    </section>

    <!-- Logs Section -->
    <section class="rounded-2xl border border-border bg-panel/50 backdrop-blur-sm shadow-lg overflow-hidden flex flex-col h-[400px]">
        <div class="px-6 py-4 border-b border-border bg-black/20 flex items-center justify-between">
            <div class="flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                </svg>
                <h2 class="text-sm font-semibold text-gray-200 uppercase tracking-wider" v-text="t('dashboard.systemLogs')"></h2>
            </div>
            <div class="flex gap-1.5">
                <div class="w-2.5 h-2.5 rounded-full bg-red-500/20 border border-red-500/50"></div>
                <div class="w-2.5 h-2.5 rounded-full bg-yellow-500/20 border border-yellow-500/50"></div>
                <div class="w-2.5 h-2.5 rounded-full bg-green-500/20 border border-green-500/50"></div>
            </div>
        </div>
        <div class="flex-1 overflow-auto p-4 font-mono text-sm bg-black/40">
            <table class="w-full text-left border-separate border-spacing-y-1">
                <thead class="text-xs text-gray-500 uppercase">
                    <tr>
                        <th class="pb-2 w-32" v-text="t('dashboard.log.time')"></th>
                        <th class="pb-2 w-24" v-text="t('dashboard.log.level')"></th>
                        <th class="pb-2" v-text="t('dashboard.log.message')"></th>
                    </tr>
                </thead>
                <tbody>
                    <tr v-for="(log, idx) in logs" :key="idx" class="group transition-colors hover:bg-white/5">
                        <td class="py-1 text-gray-500 select-none" v-text="log.time"></td>
                        <td class="py-1">
                            <span :class="['px-1.5 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider border', 
                                log.type === 'ok' 
                                    ? 'bg-accent/10 text-accent border-accent/20' 
                                    : 'bg-yellow-500/10 text-yellow-400 border-yellow-500/20']">
                                <span v-text="log.type === 'ok' ? t('log.info') : t('log.warn')"></span>
                            </span>
                        </td>
                        <td class="py-1 text-gray-300 group-hover:text-white" v-text="log.message"></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </section>
</div>
{% endblock %}

{% block scripts %}
<script>
    {% raw %}
    createApp({
        mixins: [baseMixin],
        data() {
            return {
                symbol: '',
                lastUpdated: '',
                last_price_up: true, // For color change
                prev_price: 0,
                logs: [
                    { time: 'â€”', message: '', type: 'ok' },
                ],
            }
        },
        watch: {
            last_price(newVal, oldVal) {
                if (oldVal) {
                    this.last_price_up = newVal >= oldVal
                }
            }
        },
        computed: {
            priceDisplay() {
                if (this.last_price === null || this.last_price === undefined) return '--'
                return Number(this.last_price).toFixed(2)
            },
            lastUpdatedDisplay() {
                return this.lastUpdated ? this.lastUpdated : this.t('common.timePlaceholder')
            },
        },
        methods: {
            onStatusUpdate(data) {
                this.symbol = data.symbol || ''
                this.lastUpdated = new Date().toLocaleTimeString()
            },
            async toggleBot() {
                this.loading = true
                try {
                    const res = await fetch('/api/toggle', { method: 'POST' })
                    if (!res.ok) throw new Error('Toggle failed')
                    const data = await res.json()
                    this.status = data.status || this.status
                    this.logs.unshift({ time: new Date().toLocaleTimeString(), message: this.t('dashboard.statusChanged', { status: this.statusLabel() }), type: 'ok' })
                } catch (err) {
                    console.error(err)
                    this.logs.unshift({ time: new Date().toLocaleTimeString(), message: this.t('dashboard.errorMessage', { message: err.message }), type: 'warn' })
                } finally {
                    this.loading = false
                }
            }
        },
        mounted() {
            this.setPageTitle('nav.dashboard')
            this.logs[0].message = this.t('dashboard.initLog')
        }
    }).mount('#app')
    {% endraw %}
</script>
{% endblock %}
