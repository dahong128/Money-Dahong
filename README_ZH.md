# 币安量化交易工具：需求文档与开发计划（草案）

> 已确认范围（2026-02-01）：**现货** / **Binance.com** / **CLI** / **单交易对单策略** / **工程化优先** / 交易对 **ETHUSDT** / 告警 **Telegram**。

---

## 1. 需求文档（PRD）

### 1.0 范围确认（你已回答）
- 交易类型：现货
- 交易所：Binance.com
- 交互方式：CLI（暂无 Web 面板）
- 运行形态：单交易对 + 单策略（先跑通一个 bot 实例）
- 目标倾向：工程化（稳定性、可观测、可维护优先）
- 交易对：ETHUSDT
- 告警通道：Telegram

### 1.1 背景与目标
- 背景：将交易策略从研究到实盘自动化，降低手动操作成本，提高可观测性与可控风险。
- 目标（MVP）：
  - 稳定接入币安（API Key）获取行情/账户信息。
  - 支持至少 1 个策略实盘运行（如 EMA 交叉）。
  - 具备基础风控（仓位、止损、最大回撤/最大亏损、下单保护）。
  - 有监控与告警（订单/异常/资金变化）。
  - 可回测同一策略（同一套信号逻辑）。

### 1.2 用户与使用场景
- 用户：单用户（你），未来可扩展到多账户/多策略。
- 场景：
  - 配置交易对与策略参数 → 一键启动机器人。
  - 随时暂停/恢复、手动平仓。
  - 查看当前持仓、订单、PnL、策略状态、日志。
  - 回测并导出结果，对比不同参数。

### 1.3 功能需求（按模块）

#### A. 账户与权限
- 配置/加密存储 API Key/Secret（支持只读模式与交易模式）。
- 校验权限、连通性测试、限频提示。

#### B. 行情与数据
- 获取 K 线（指定周期）、最新价、深度（可选）。
- 实盘：WebSocket 优先，REST 兜底重连。
- 本地缓存与持久化（用于回测/复盘）。

#### C. 策略系统
- 策略接口规范：`on_bar/on_tick`、`generate_signal`、`position_sizing`。
- 参数化：交易对、周期、指标参数、交易时间窗（可选）。
- 策略生命周期：启动/停止/热更新参数（可选）。

#### D. 交易执行（Execution）
- 下单类型：市价/限价（MVP 先市价 + 限价二选一即可）。
- 订单状态跟踪：提交 → 成交 → 撤单 → 失败。
- 幂等与去重：避免重复下单（如网络抖动/重启）。
- 滑点与手续费处理（用于回测与实盘统计）。

#### E. 风控（Risk）
- 单笔风险：最大仓位、最大下单金额、最小下单量校验。
- 全局风险：最大日亏损/最大回撤触发熔断（暂停交易）。
- 止损/止盈：固定比例或 ATR（可选）。
- 交易保护：价格偏离阈值、短时间频繁交易限制、冷却时间。

#### F. 回测（Backtest）
- 数据源：本地 K 线（先做 bar 级别回测）。
- 成本模型：手续费、滑点。
- 输出：净值曲线、胜率、最大回撤、Sharpe（可选）、交易明细导出 CSV。

#### G. 监控与运维
- 日志：结构化日志（策略、订单、风控、异常）。
- 指标：运行状态、延迟、下单成功率、PnL。
- 告警：邮件/Telegram/企业微信（先选一种）。

#### H. 管理界面（可选两种）
- 当前选择：仅 CLI。
- 能力：启动/停止机器人、查看持仓订单、策略参数管理、导出日志/交易明细。

### 1.4 非功能需求
- 安全：Key 不落盘明文；支持 `.env` 但加密更好；最小权限。
- 稳定：断线重连、任务自恢复、异常隔离（策略崩不拖垮执行器）。
- 可观测：关键链路可追踪（信号 → 风控 → 下单 → 成交）。
- 性能：MVP 不追求极致低延迟，但要避免阻塞与漏单。
- 可扩展：新增策略/交易所尽量不改核心模块。

### 1.5 约束与合规提示（需要确认）
- 已确认：`Binance.com` + 现货。
- 仍需确认：部署位置（本地 Mac / VPS / Docker？）。
- 风险提示：量化实盘有亏损风险，尤其杠杆合约；建议先模拟盘或小额白名单交易对。

### 1.6 验收标准（MVP）
- 能在指定交易对（如 BTCUSDT）上稳定跑满 24 小时不断线（允许自动重连）。
- 订单状态一致（本地状态与交易所一致），不重复下单。
- 风控能在触发条件下阻止下单并告警。
- 回测与实盘同一策略信号逻辑复用（同一份策略代码）。

---

## 2. 开发计划（里程碑）

### 2.0 工程化基线（贯穿全程）
- 代码质量：格式化、lint、类型检查（可选）、单元测试最小集、预提交钩子（可选）。
- 可观测：结构化日志（JSON 或 key-value）、关键事件统一字段（`strategy_id`、`symbol`、`order_id`、`trace_id` 等）。
- 可运维：配置与 secrets 分离、可重复部署、明确的运行命令与故障排查步骤。
- 可靠性：重试/超时/限频、断线重连、幂等、可恢复启动（从交易所拉状态）。

### Milestone 0：技术选型与脚手架（0.5–1 天）
- 语言/框架：`Python 3.11+`，`asyncio`；CLI 用 `typer` 或 `argparse`（二选一）。
- 目录结构、配置体系（`.env` + 明确的 config schema）、日志规范、CI（lint + test）。
- 基础约定：统一时区/时间戳、Decimal 精度策略、错误码/异常体系。

### Milestone 1：交易所适配层（2–4 天）
- REST：账户、余额、下单、撤单、查询订单、K 线。
- WebSocket：行情订阅 + 自动重连。
- 限频与重试策略（指数退避 + 业务可重试白名单）。

### Milestone 2：执行引擎与状态机（3–5 天）
- 订单状态机、幂等 key、重启恢复（从交易所拉取未完成订单）。
- Position/PnL 计算（先简单：现货持仓 + 已实现/未实现）。
- 交易保护：下单前校验（最小下单量、步进、最小名义价值）、价格偏离保护。

### Milestone 3：策略框架 + 示例策略（2–4 天）
- 策略基类、参数、信号规范。
- 内置 1–2 个策略（EMA Cross / 均值回归二选一）。

### Milestone 4：风控模块（2–4 天）
- 仓位/金额/频率限制、熔断、止损止盈（先最小集）。
- 风控事件与告警接口。

### Milestone 5：回测引擎（3–6 天）
- bar 级回测、成本模型、报表输出（CSV + 简单图表可选）。
- 策略复用：同策略代码可跑回测/实盘。

### Milestone 6：监控与管理面板（2–5 天）
- CLI：启动/停止/状态/导出日志。
- 暂不做 Web：后续如需要，可新增状态页、策略参数页、订单与持仓页。

### Milestone 7：上线与运行手册（1–2 天）
- Docker 化（可选）、配置说明、故障排查清单。
- “小额模式”与逐步放量策略（防止一上来全仓）。

---

## 3. 下一步需要补齐的信息（便于直接开工）
1) 策略选择：先用 `EMA Cross` 作为 MVP 策略可以吗？
2) 下单偏好：市价 / 限价（MVP 建议先市价，配合价格偏离保护）
3) 部署方式：本地 Mac / VPS / Docker（建议 VPS 或 Docker，便于 7x24）
4) 资金与风险参数：初始资金、单笔最大下单金额、最大仓位、最大日亏损/最大回撤
5) 运行频率：K 线周期（例如 `1m/5m/15m`）与是否需要 WebSocket（先 REST 轮询也可）

---

## 4. 快速开始（CLI）
1) 安装（开发模式）：
   - `python3.12 -m venv .venv && source .venv/bin/activate`
   - `python -m pip install -U pip`
   - `python -m pip install -e '.[dev]'`
2) 配置：
   - `cp .env.example .env`（或 `money-dahong config-init`）
   - 填写 `.env`：`BINANCE_API_KEY/BINANCE_API_SECRET`、`TELEGRAM_BOT_TOKEN/TELEGRAM_CHAT_ID`
3) 连通性：
   - `money-dahong health`
   - `money-dahong alerts-test --message 'hello'`
4) 运行（默认 dry-run，不会真实下单）：
   - `money-dahong run`
5) 实盘（需要显式确认）：
   - `.env` 设置 `TRADING_MODE=live` 且 `CONFIRM_LIVE_TRADING=YES`

---

## 5. 使用 Docker（推荐 7x24 部署）
1) 配置：
   - `cp .env.example .env` 并填写 `BINANCE_API_KEY/BINANCE_API_SECRET`、`TELEGRAM_BOT_TOKEN/TELEGRAM_CHAT_ID`
2) 构建镜像：
   - `docker compose build`
3) 连通性检查（一次性运行）：
   - `docker compose --profile cli run --rm cli health`
   - `docker compose --profile cli run --rm cli alerts-test --message 'hello'`
4) 启动机器人（后台常驻）：
   - `docker compose up -d bot`
5) 查看日志：
   - `docker compose logs -f bot`
6) 停止：
   - `docker compose down`
